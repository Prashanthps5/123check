// rsocketClient.ts
import {
  RSocketClient,
  JsonSerializer,
  IdentitySerializer,
  encodeRoute,
} from "rsocket-core";
import RSocketWebSocketClient from "rsocket-websocket-client";

const WS_URL = "ws://localhost:8080/rsocket";

export function createRSocketClient() {
  return new RSocketClient({
    serializers: {
      data: JsonSerializer,
      metadata: IdentitySerializer,
    },

    setup: {
      keepAlive: 30000,
      lifetime: 120000,
      dataMimeType: "application/json",
      metadataMimeType: "message/x.rsocket.routing.v0",
    },

    transport: new RSocketWebSocketClient(
      { url: WS_URL },
      Buffer
    ),
  });
}

export { encodeRoute };


// rsocketManager.ts
import { createRSocketClient } from "./rsocketClient";

const MAX_RETRIES = Infinity;
const RECONNECT_DELAY = 3000;

export class RSocketManager {
  private socket: any = null;
  private retries = 0;
  private closedByUser = false;

  connect(onConnect: (socket: any) => void, onError?: (e: any) => void) {
    const client = createRSocketClient();

    client.connect().subscribe({
      onComplete: (socket) => {
        this.socket = socket;
        this.retries = 0;
        onConnect(socket);
      },

      onError: (error) => {
        if (this.closedByUser) return;

        onError?.(error);

        if (this.retries < MAX_RETRIES) {
          this.retries++;
          setTimeout(() => this.connect(onConnect, onError), RECONNECT_DELAY);
        }
      },
    });
  }

  close() {
    this.closedByUser = true;
    this.socket?.close();
  }
}





// useRSocketStream.ts
import { useEffect, useRef, useState } from "react";
import { encodeRoute } from "./rsocketClient";
import { RSocketManager } from "./rsocketManager";

export function useRSocketStream<T>(
  route: string,
  requestData?: any
) {
  const managerRef = useRef<RSocketManager>();
  const subscriptionRef = useRef<any>();

  const [data, setData] = useState<T[]>([]);
  const [connected, setConnected] = useState(false);
  const [error, setError] = useState<any>(null);

  useEffect(() => {
    managerRef.current = new RSocketManager();

    managerRef.current.connect(
      (socket) => {
        setConnected(true);
        setError(null);

        subscriptionRef.current = socket
          .requestStream({
            data: requestData ?? {},
            metadata: encodeRoute(route),
          })
          .subscribe({
            onNext: (payload) =>
              setData((prev) => [...prev, payload.data]),

            onError: (err) => {
              setConnected(false);
              setError(err);
            },

            onComplete: () => setConnected(false),
          });
      },
      (err) => setError(err)
    );

    return () => {
      subscriptionRef.current?.cancel();
      managerRef.current?.close();
    };
  }, [route]);

  return { data, connected, error };
}





import React, { useEffect, useState } from "react";
import {
  RSocketClient,
  JsonSerializers,
  Payload,
} from "rsocket-core";
import RSocketWebSocketClient from "rsocket-websocket-client";

type ServerMessage = {
  message: string;
};

const App: React.FC = () => {
  const [messages, setMessages] = useState<ServerMessage[]>([]);
  const [status, setStatus] = useState<string>("Connecting...");

  useEffect(() => {
    const client = new RSocketClient<Payload, Payload>({
      serializers: JsonSerializers,
      setup: {
        keepAlive: 60000,
        lifetime: 180000,
        dataMimeType: "application/json",
        metadataMimeType: "application/json",
      },
      transport: new RSocketWebSocketClient(
        {
          url: "wss://rsocket-demo.herokuapp.com/rsocket",
        },
        { debug: true }
      ),
    });

    let cancelStream: (() => void) | null = null;

    client.connect().subscribe({
      onComplete: (socket) => {
        setStatus("Connected ✅");

        socket
          .requestStream({
            data: { name: "React TSX User" },
            metadata: null,
          })
          .subscribe({
            onSubscribe: (sub) => {
              cancelStream = () => sub.cancel();
              sub.request(2147483647); // request max items
            },
            onNext: (payload) => {
              setMessages((prev) => [
                ...prev,
                payload.data as ServerMessage,
              ]);
            },
            onError: (error) => {
              console.error(error);
              setStatus("Stream error ❌");
            },
            onComplete: () => {
              setStatus("Stream completed");
            },
          });
      },
      onError: (error) => {
        console.error(error);
        setStatus("Connection failed ❌");
      },
    });

    return () => {
      if (cancelStream) {
        cancelStream();
      }
    };
  }, []);

  return (
    <div style={{ padding: 20 }}>
      <h2>React 18 + RSocket (TSX)</h2>
      <p>Status: {status}</p>

      <h3>Messages</h3>
      <ul>
        {messages.map((msg, idx) => (
          <li key={idx}>{msg.message}</li>
        ))}
      </ul>
    </div>
  );
};

export default App;


const {
  RSocketServer,
  JsonSerializers,
} = require("rsocket-core");
const RSocketWebSocketServer = require("rsocket-websocket-server").default;

const server = new RSocketServer({
  serializers: JsonSerializers,
  transport: new RSocketWebSocketServer({
    port: 7000,
    path: "/rsocket",
  }),
  getRequestHandler: () => ({
    requestResponse: (payload) => {
      return {
        subscribe: (subscriber) => {
          subscriber.onNext({
            data: { message: "Echo: " + payload.data.name },
          });
          subscriber.onComplete();
        },
      };
    },
  }),
});

server.start();
console.log("RSocket server running on ws://localhost:7000/rsocket");
